# Scala CircleCI 2.1 configuration file
#
# Check https://circleci.com/docs/2.0/sample-config/ for more details
#

version: 2.1

executors:
  chisel-executor:
    # Use the chisel3-tools image to build and run FIRRTL and chisel tests.
    docker:
      - image: ucbbar/chisel3-tools
        user: "chisel"

    working_directory: ~/repo

    environment:
      # Customize the JVM maximum heap limit
      JVM_OPTS: -Xmx3072m
      TERM: dumb
      RELEASE_REV: origin/master
      CHECKSTYLE_LIMIT: 40
      SBT_ARGS: "; set ThisBuild / parallelExecution := false; set ThisBuild / fork := false; set ThisBuild / testForkedParallel := false"

commands:
  restore-workspace:
    description: "Attach to workspace"
    steps:
      - attach_workspace:
          at: /home/chisel

  save-workspace:
    description: "Save workspace"
    parameters:
      package:
        type: string
        default: ""
    steps:
      - persist_to_workspace:
          root: /home/chisel
          paths:
            - .ivy2/local/edu.berkeley.cs/<< parameters.package >>

  publish-component:
    description: "Publish a component"
    parameters:
      component:
        type: string
        default: ""
      scalaVersion:
        type: string
        default: ""
      sbtFlags:
        type: string
        default: ""
    steps:
      - run:
          command: |
            (cd chisel-release/<< parameters.component >> && cat /dev/null | sbt "$SBT_ARGS" << parameters.sbtFlags >> << parameters.scalaVersion >> publishLocal)

  test-component:
    description: "Run component tests with a specific Scala version"
    parameters:
      component:
        type: string
        default: ""
      scalaVersion:
        type: string
        default: ""
      sbtFlags:
        type: string
        default: ""
    steps:

      # Set environment
      - run: echo 'export PATH="/opt/verilator/verilator_4_016/bin:/opt/yosys/bin:$PATH"' >> $BASH_ENV

      # The -DminimalResources flag causes sbt to run tests sequentially,
      #  so we could actually use "sbt +test" to run all the crossVersioned tests.
      # We currently run them separately so we can run them in parallel.
      - run:
          command: |
            (cd chisel-release/<< parameters.component >> && cat /dev/null | sbt "$SBT_ARGS" -DminimalResources << parameters.scalaVersion >> test)

  checkstyle-component:
    description: "Verify coding style"
    parameters:
      component:
        type: string
        default: ""
    steps:

      - run:
          command: |
            # We expect the "[info]" field from sbt so the warning count will be in column 4
            (cd chisel-release/<< parameters.component >> && cat /dev/null | sbt "$SBT_ARGS" scalastyle | gawk -v WARN_FAIL=2 -e '/scalastyle Found [0-9]+ warnings/ { print $0; if ($4 > ENVIRON["CHECKSTYLE_LIMIT"]) WARN_FAIL=1; else if (WARN_FAIL == 2) WARN_FAIL=0 }' -e 'END { exit WARN_FAIL}')

jobs:
  build-prep:
    executor: chisel-executor

    steps:

      # Checkout all release components.
      - checkout:
          path: chisel-release

      - run:
          command: |
            (cd chisel-release && git submodule sync && git submodule update --init --recursive)
            date > date.prep
            printenv
            ls -l


      - persist_to_workspace:
          root: /home/chisel
          paths:
            - repo
            - .coursier
            - .ivy2
            - .m2
            - .sbt

  build-firrtl:
    executor: chisel-executor

    steps:
      - restore-workspace
      - restore_cache:
          keys:
            - v1-dep--firrtl--{{ checksum "chisel-release/firrtl/build.sbt" }}--{{ checksum "chisel-release/firrtl/project/plugins.sbt" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dep--firrtl

      # publish FIRRTL
      - publish-component:
          component: "firrtl"
          scalaVersion: "++2.11.12"
      - save-workspace:
          package: "firrtl_2.11"
      - publish-component:
          component: "firrtl"
          scalaVersion: "++2.12.10"
      - save-workspace:
          package: "firrtl_2.12"
      - save_cache:
          paths:
            - ~/.coursier
            - ~/.ivy2
            - ~/.m2
            - ~/.sbt
          key: v1-dep--firrtl--{{ checksum "chisel-release/firrtl/build.sbt" }}--{{ checksum "chisel-release/firrtl/project/plugins.sbt" }}

  test-firrtl-2_11:
    executor: chisel-executor

    steps:
      - restore-workspace
      - restore_cache:
          keys:
            - v1-dep--firrtl--{{ checksum "chisel-release/firrtl/build.sbt" }}--{{ checksum "chisel-release/firrtl/project/plugins.sbt" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dep--firrtl

      - test-component:
          component: "firrtl"
          scalaVersion: "++2.11.12"

  test-firrtl-2_12:
    executor: chisel-executor

    steps:
      - restore-workspace
      - restore_cache:
          keys:
            - v1-dep--firrtl--{{ checksum "chisel-release/firrtl/build.sbt" }}--{{ checksum "chisel-release/firrtl/project/plugins.sbt" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dep--firrtl

      - test-component:
          component: "firrtl"
          scalaVersion: "++2.12.10"

  # Define a pure build chisel - currently unused since we can compile and test chisel in one step
  #  and we don't have downstream jobs that need the published version of chisel.
  build-chisel:
    executor: chisel-executor

    steps:
      - restore-workspace
      - restore_cache:
          keys:
            - v1-dep--chisel3--{{ checksum "chisel-release/chisel3/build.sbt" }}--{{ checksum "chisel-release/chisel3/project/plugins.sbt" }}
            - v1-dep--firrtl--{{ checksum "chisel-release/firrtl/build.sbt" }}--{{ checksum "chisel-release/firrtl/project/plugins.sbt" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dep--firrtl

      # publish chisel
      - publish-component:
          component: "chisel3"
          scalaVersion: "++2.11.12"
      - save-workspace:
          package: "chisel3_2.11"
      - publish-component:
          component: "chisel3"
          scalaVersion: "++2.12.10"
      - save-workspace:
          package: "chisel3_2.12"
      - save_cache:
          paths:
            - ~/.coursier
            - ~/.ivy2
            - ~/.m2
            - ~/.sbt
          key: v1-dep--chisel3--{{ checksum "chisel-release/chisel3/build.sbt" }}--{{ checksum "chisel-release/chisel3/project/plugins.sbt" }}

  test-chisel-2_11:
    executor: chisel-executor
    steps:
      - restore-workspace
      - restore_cache:
          keys:
            - v1-dep--chisel3--{{ checksum "chisel-release/chisel3/build.sbt" }}--{{ checksum "chisel-release/chisel3/project/plugins.sbt" }}
            - v1-dep--firrtl--{{ checksum "chisel-release/firrtl/build.sbt" }}--{{ checksum "chisel-release/firrtl/project/plugins.sbt" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dep--firrtl
      - test-component:
          component: "chisel3"
          scalaVersion: "++2.11.12"

  test-chisel-2_12:
    executor: chisel-executor
    steps:
      - restore-workspace
      - restore_cache:
          keys:
            - v1-dep--chisel3--{{ checksum "chisel-release/chisel3/build.sbt" }}--{{ checksum "chisel-release/chisel3/project/plugins.sbt" }}
            - v1-dep--firrtl--{{ checksum "chisel-release/firrtl/build.sbt" }}--{{ checksum "chisel-release/firrtl/project/plugins.sbt" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dep--firrtl
      - test-component:
          component: "chisel3"
          scalaVersion: "++2.12.10"

  checkstyle-chisel:
    executor: chisel-executor
    steps:
      - restore-workspace
      - restore_cache:
          keys:
            - v1-dep--chisel3--{{ checksum "chisel-release/chisel3/build.sbt" }}--{{ checksum "chisel-release/chisel3/project/plugins.sbt" }}
            - v1-dep--firrtl--{{ checksum "chisel-release/firrtl/build.sbt" }}--{{ checksum "chisel-release/firrtl/project/plugins.sbt" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dep--firrtl

      - checkstyle-component:
          component: "chisel3"

  build-firrtl-interpreter:
    executor: chisel-executor

    steps:
      - restore-workspace
      - restore_cache:
          keys:
            - v1-dep--firrtl-interpreter--{{ checksum "chisel-release/firrtl-interpreter/build.sbt" }}--{{ checksum "chisel-release/firrtl-interpreter/project/plugins.sbt" }}
            - v1-dep--firrtl--{{ checksum "chisel-release/firrtl/build.sbt" }}--{{ checksum "chisel-release/firrtl/project/plugins.sbt" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dep--firrtl

      # publish firrtl-interpreter
      - publish-component:
          component: "firrtl-interpreter"
          scalaVersion: "++2.11.12"
      - save-workspace:
          package: "firrtl-interpreter_2.11"
      - publish-component:
          component: "firrtl-interpreter"
          scalaVersion: "++2.12.10"
      - save-workspace:
          package: "firrtl-interpreter_2.12"
      - save_cache:
          paths:
            - ~/.coursier
            - ~/.ivy2
            - ~/.m2
            - ~/.sbt
          key: v1-dep--firrtl-interpreter--{{ checksum "chisel-release/firrtl-interpreter/build.sbt" }}--{{ checksum "chisel-release/firrtl-interpreter/project/plugins.sbt" }}

  test-firrtl-interpreter-2_11:
    executor: chisel-executor

    steps:
      - restore-workspace
      - restore_cache:
          keys:
            - v1-dep--firrtl-interpreter--{{ checksum "chisel-release/firrtl-interpreter/build.sbt" }}--{{ checksum "chisel-release/firrtl-interpreter/project/plugins.sbt" }}
            - v1-dep--firrtl--{{ checksum "chisel-release/firrtl/build.sbt" }}--{{ checksum "chisel-release/firrtl/project/plugins.sbt" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dep--firrtl

      - test-component:
          component: "firrtl-interpreter"
          scalaVersion: "++2.11.12"

  test-firrtl-interpreter-2_12:
    executor: chisel-executor

    steps:
      - restore-workspace
      - restore_cache:
          keys:
            - v1-dep--firrtl-interpreter--{{ checksum "chisel-release/firrtl-interpreter/build.sbt" }}--{{ checksum "chisel-release/firrtl-interpreter/project/plugins.sbt" }}
            - v1-dep--firrtl--{{ checksum "chisel-release/firrtl/build.sbt" }}--{{ checksum "chisel-release/firrtl/project/plugins.sbt" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dep--firrtl

      - test-component:
          component: "firrtl-interpreter"
          scalaVersion: "++2.12.10"

  build-treadle:
    executor: chisel-executor

    steps:
      - restore-workspace
      - restore_cache:
          keys:
            - v1-dep--treadle--{{ checksum "chisel-release/treadle/build.sbt" }}--{{ checksum "chisel-release/treadle/project/plugins.sbt" }}
            - v1-dep--firrtl--{{ checksum "chisel-release/firrtl/build.sbt" }}--{{ checksum "chisel-release/firrtl/project/plugins.sbt" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dep--firrtl

      # publish treadle
      - publish-component:
          component: "treadle"
          scalaVersion: "++2.11.12"
      - save-workspace:
          package: "treadle_2.11"
      - publish-component:
          component: "treadle"
          scalaVersion: "++2.12.10"
      - save-workspace:
          package: "treadle_2.12"
      - save_cache:
          paths:
            - ~/.coursier
            - ~/.ivy2
            - ~/.m2
            - ~/.sbt
          key: v1-dep--treadle--{{ checksum "chisel-release/treadle/build.sbt" }}--{{ checksum "chisel-release/treadle/project/plugins.sbt" }}

  test-treadle-2_11:
    executor: chisel-executor

    steps:
      - restore-workspace
      - restore_cache:
          keys:
            - v1-dep--treadle--{{ checksum "chisel-release/treadle/build.sbt" }}--{{ checksum "chisel-release/treadle/project/plugins.sbt" }}
            - v1-dep--firrtl--{{ checksum "chisel-release/firrtl/build.sbt" }}--{{ checksum "chisel-release/firrtl/project/plugins.sbt" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dep--firrtl

      - test-component:
          component: "treadle"
          scalaVersion: "++2.11.12"

  test-treadle-2_12:
    executor: chisel-executor

    steps:
      - restore-workspace
      - restore_cache:
          keys:
            - v1-dep--treadle--{{ checksum "chisel-release/treadle/build.sbt" }}--{{ checksum "chisel-release/treadle/project/plugins.sbt" }}
            - v1-dep--firrtl--{{ checksum "chisel-release/firrtl/build.sbt" }}--{{ checksum "chisel-release/firrtl/project/plugins.sbt" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dep--firrtl

      - test-component:
          component: "treadle"
          scalaVersion: "++2.12.10"

  build-diagrammer:
    executor: chisel-executor

    steps:
      - restore-workspace
      - restore_cache:
          keys:
            - v1-dep--diagrammer--{{ checksum "chisel-release/diagrammer/build.sbt" }}--{{ checksum "chisel-release/diagrammer/project/plugins.sbt" }}
            - v1-dep--chisel3--{{ checksum "chisel-release/chisel3/build.sbt" }}--{{ checksum "chisel-release/chisel3/project/plugins.sbt" }}
            - v1-dep--firrtl--{{ checksum "chisel-release/firrtl/build.sbt" }}--{{ checksum "chisel-release/firrtl/project/plugins.sbt" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dep--firrtl

      # publish diagrammer
      - publish-component:
          component: "diagrammer"
          scalaVersion: "++2.11.12"
      - save-workspace:
          package: "firrtl-diagrammer_2.11"
      - publish-component:
          component: "diagrammer"
          scalaVersion: "++2.12.10"
      - save-workspace:
          package: "firrtl-diagrammer_2.12"
      - save_cache:
          paths:
            - ~/.coursier
            - ~/.ivy2
            - ~/.m2
            - ~/.sbt
          key: v1-dep--diagrammer--{{ checksum "chisel-release/diagrammer/build.sbt" }}--{{ checksum "chisel-release/diagrammer/project/plugins.sbt" }}

  test-diagrammer-2_11:
    executor: chisel-executor

    steps:
      - restore-workspace
      - restore_cache:
          keys:
            - v1-dep--diagrammer--{{ checksum "chisel-release/diagrammer/build.sbt" }}--{{ checksum "chisel-release/diagrammer/project/plugins.sbt" }}
            - v1-dep--chisel3--{{ checksum "chisel-release/chisel3/build.sbt" }}--{{ checksum "chisel-release/chisel3/project/plugins.sbt" }}
            - v1-dep--firrtl--{{ checksum "chisel-release/firrtl/build.sbt" }}--{{ checksum "chisel-release/firrtl/project/plugins.sbt" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dep--firrtl

      - test-component:
          component: "diagrammer"
          scalaVersion: "++2.11.12"

  test-diagrammer-2_12:
    executor: chisel-executor

    steps:
      - restore-workspace
      - restore_cache:
          keys:
            - v1-dep--diagrammer--{{ checksum "chisel-release/diagrammer/build.sbt" }}--{{ checksum "chisel-release/diagrammer/project/plugins.sbt" }}
            - v1-dep--chisel3--{{ checksum "chisel-release/chisel3/build.sbt" }}--{{ checksum "chisel-release/chisel3/project/plugins.sbt" }}
            - v1-dep--firrtl--{{ checksum "chisel-release/firrtl/build.sbt" }}--{{ checksum "chisel-release/firrtl/project/plugins.sbt" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dep--firrtl

      - test-component:
          component: "diagrammer"
          scalaVersion: "++2.12.10"

  build-chisel-testers:
    executor: chisel-executor

    steps:
      - restore-workspace
      - restore_cache:
          keys:
            - v1-dep--chisel-testers--{{ checksum "chisel-release/chisel-testers/build.sbt" }}--{{ checksum "chisel-release/chisel-testers/project/plugins.sbt" }}
            - v1-dep--chisel3--{{ checksum "chisel-release/chisel3/build.sbt" }}--{{ checksum "chisel-release/chisel3/project/plugins.sbt" }}
            - v1-dep--firrtl--{{ checksum "chisel-release/firrtl/build.sbt" }}--{{ checksum "chisel-release/firrtl/project/plugins.sbt" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dep--firrtl

      # publish chisel-testers
      - publish-component:
          component: "chisel-testers"
          scalaVersion: "++2.11.12"
      - save-workspace:
          package: "chisel-iotesters_2.11"
      - publish-component:
          component: "chisel-testers"
          scalaVersion: "++2.12.10"
      - save-workspace:
          package: "chisel-iotesters_2.12"
      - save_cache:
          paths:
            - ~/.coursier
            - ~/.ivy2
            - ~/.m2
            - ~/.sbt
          key: v1-dep--chisel-testers--{{ checksum "chisel-release/chisel-testers/build.sbt" }}--{{ checksum "chisel-release/chisel-testers/project/plugins.sbt" }}

  test-chisel-testers-2_11:
    executor: chisel-executor

    steps:
      - restore-workspace
      - restore_cache:
          keys:
            - v1-dep--chisel-testers--{{ checksum "chisel-release/chisel-testers/build.sbt" }}--{{ checksum "chisel-release/chisel-testers/project/plugins.sbt" }}
            - v1-dep--chisel3--{{ checksum "chisel-release/chisel3/build.sbt" }}--{{ checksum "chisel-release/chisel3/project/plugins.sbt" }}
            - v1-dep--firrtl--{{ checksum "chisel-release/firrtl/build.sbt" }}--{{ checksum "chisel-release/firrtl/project/plugins.sbt" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dep--firrtl

      - test-component:
          component: "chisel-testers"
          scalaVersion: "++2.11.12"

  test-chisel-testers-2_12:
    executor: chisel-executor

    steps:
      - restore-workspace
      - restore_cache:
          keys:
            - v1-dep--chisel-testers--{{ checksum "chisel-release/chisel-testers/build.sbt" }}--{{ checksum "chisel-release/chisel-testers/project/plugins.sbt" }}
            - v1-dep--chisel3--{{ checksum "chisel-release/chisel3/build.sbt" }}--{{ checksum "chisel-release/chisel3/project/plugins.sbt" }}
            - v1-dep--firrtl--{{ checksum "chisel-release/firrtl/build.sbt" }}--{{ checksum "chisel-release/firrtl/project/plugins.sbt" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dep--firrtl

      - test-component:
          component: "chisel-testers"
          scalaVersion: "++2.12.10"

  build-chisel-testers2:
    executor: chisel-executor

    steps:
      - restore-workspace
      - restore_cache:
          keys:
            - v1-dep--chisel-testers2--{{ checksum "chisel-release/chisel-testers2/build.sbt" }}--{{ checksum "chisel-release/chisel-testers2/project/plugins.sbt" }}
            - v1-dep--chisel3--{{ checksum "chisel-release/chisel3/build.sbt" }}--{{ checksum "chisel-release/chisel3/project/plugins.sbt" }}
            - v1-dep--firrtl--{{ checksum "chisel-release/firrtl/build.sbt" }}--{{ checksum "chisel-release/firrtl/project/plugins.sbt" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dep--firrtl

      # publish chisel-testers2
      - publish-component:
          component: "chisel-testers2"
          scalaVersion: "++2.11.12"
      - save-workspace:
          package: "chisel-testers2_2.11"
      - publish-component:
          component: "chisel-testers2"
          scalaVersion: "++2.12.10"
      - save-workspace:
          package: "chisel-testers2_2.12"
      - save_cache:
          paths:
            - ~/.coursier
            - ~/.ivy2
            - ~/.m2
            - ~/.sbt
          key: v1-dep--chisel-testers2--{{ checksum "chisel-release/chisel-testers2/build.sbt" }}--{{ checksum "chisel-release/chisel-testers2/project/plugins.sbt" }}

  test-chisel-testers2-2_11:
    executor: chisel-executor

    steps:
      - restore-workspace
      - restore_cache:
          keys:
            - v1-dep--chisel-testers2--{{ checksum "chisel-release/chisel-testers2/build.sbt" }}--{{ checksum "chisel-release/chisel-testers2/project/plugins.sbt" }}
            - v1-dep--chisel3--{{ checksum "chisel-release/chisel3/build.sbt" }}--{{ checksum "chisel-release/chisel3/project/plugins.sbt" }}
            - v1-dep--firrtl--{{ checksum "chisel-release/firrtl/build.sbt" }}--{{ checksum "chisel-release/firrtl/project/plugins.sbt" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dep--firrtl

      - test-component:
          component: "chisel-testers2"
          scalaVersion: "++2.11.12"

  test-chisel-testers2-2_12:
    executor: chisel-executor

    steps:
      - restore-workspace
      - restore_cache:
          keys:
            - v1-dep--chisel-testers2--{{ checksum "chisel-release/chisel-testers2/build.sbt" }}--{{ checksum "chisel-release/chisel-testers2/project/plugins.sbt" }}
            - v1-dep--chisel3--{{ checksum "chisel-release/chisel3/build.sbt" }}--{{ checksum "chisel-release/chisel3/project/plugins.sbt" }}
            - v1-dep--firrtl--{{ checksum "chisel-release/firrtl/build.sbt" }}--{{ checksum "chisel-release/firrtl/project/plugins.sbt" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dep--firrtl

      - test-component:
          component: "chisel-testers2"
          scalaVersion: "++2.12.10"

  build-dsptools:
    executor: chisel-executor

    steps:
      - restore-workspace
      - restore_cache:
          keys:
            - v1-dep--dsptools--{{ checksum "chisel-release/dsptools/build.sbt" }}--{{ checksum "chisel-release/dsptools2/project/plugins.sbt" }}
            - v1-dep--chisel-testers2--{{ checksum "chisel-release/chisel-testers2/build.sbt" }}--{{ checksum "chisel-release/chisel-testers2/project/plugins.sbt" }}
            - v1-dep--chisel-testers--{{ checksum "chisel-release/chisel-testers/build.sbt" }}--{{ checksum "chisel-release/chisel-testers/project/plugins.sbt" }}
            - v1-dep--chisel3--{{ checksum "chisel-release/chisel3/build.sbt" }}--{{ checksum "chisel-release/chisel3/project/plugins.sbt" }}
            - v1-dep--firrtl--{{ checksum "chisel-release/firrtl/build.sbt" }}--{{ checksum "chisel-release/firrtl/project/plugins.sbt" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dep--firrtl

      # publish dsptools
      - publish-component:
          component: "dsptools"
          scalaVersion: "++2.11.12"
      - save-workspace:
          package: "dsptools_2.11"
      - publish-component:
          component: "dsptools"
          scalaVersion: "++2.12.10"
      - save-workspace:
          package: "dsptools_2.12"
      - save_cache:
          paths:
            - ~/.coursier
            - ~/.ivy2
            - ~/.m2
            - ~/.sbt
          key: v1-dep--dsptools--{{ checksum "chisel-release/dsptools/build.sbt" }}--{{ checksum "chisel-release/dsptools/project/plugins.sbt" }}

  test-dsptools-2_11:
    executor: chisel-executor

    steps:
      - restore-workspace
      - restore_cache:
          keys:
            - v1-dep--dsptools--{{ checksum "chisel-release/dsptools/build.sbt" }}--{{ checksum "chisel-release/dsptools2/project/plugins.sbt" }}
            - v1-dep--chisel-testers2--{{ checksum "chisel-release/chisel-testers2/build.sbt" }}--{{ checksum "chisel-release/chisel-testers2/project/plugins.sbt" }}
            - v1-dep--chisel-testers--{{ checksum "chisel-release/chisel-testers/build.sbt" }}--{{ checksum "chisel-release/chisel-testers/project/plugins.sbt" }}
            - v1-dep--chisel3--{{ checksum "chisel-release/chisel3/build.sbt" }}--{{ checksum "chisel-release/chisel3/project/plugins.sbt" }}
            - v1-dep--firrtl--{{ checksum "chisel-release/firrtl/build.sbt" }}--{{ checksum "chisel-release/firrtl/project/plugins.sbt" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dep--firrtl

      - test-component:
          component: "dsptools"
          scalaVersion: "++2.11.12"

  test-dsptools-2_12:
    executor: chisel-executor

    steps:
      - restore-workspace
      - restore_cache:
          keys:
            - v1-dep--dsptools--{{ checksum "chisel-release/dsptools/build.sbt" }}--{{ checksum "chisel-release/dsptools2/project/plugins.sbt" }}
            - v1-dep--chisel-testers2--{{ checksum "chisel-release/chisel-testers2/build.sbt" }}--{{ checksum "chisel-release/chisel-testers2/project/plugins.sbt" }}
            - v1-dep--chisel-testers--{{ checksum "chisel-release/chisel-testers/build.sbt" }}--{{ checksum "chisel-release/chisel-testers/project/plugins.sbt" }}
            - v1-dep--chisel3--{{ checksum "chisel-release/chisel3/build.sbt" }}--{{ checksum "chisel-release/chisel3/project/plugins.sbt" }}
            - v1-dep--firrtl--{{ checksum "chisel-release/firrtl/build.sbt" }}--{{ checksum "chisel-release/firrtl/project/plugins.sbt" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dep--firrtl

      - test-component:
          component: "dsptools"
          scalaVersion: "++2.12.10"

  build-rocket-dsptools:
    executor: chisel-executor

    steps:
      - restore-workspace
      - restore_cache:
          keys:
            - v1-dep--rocketchip--{{ checksum "chisel-release/rocketchip/build.sbt" }}--{{ checksum "chisel-release/rocketchip/project/plugins.sbt" }}
            - v1-dep--dsptools--{{ checksum "chisel-release/dsptools/build.sbt" }}--{{ checksum "chisel-release/dsptools2/project/plugins.sbt" }}
            - v1-dep--chisel-testers2--{{ checksum "chisel-release/chisel-testers2/build.sbt" }}--{{ checksum "chisel-release/chisel-testers2/project/plugins.sbt" }}
            - v1-dep--chisel-testers--{{ checksum "chisel-release/chisel-testers/build.sbt" }}--{{ checksum "chisel-release/chisel-testers/project/plugins.sbt" }}
            - v1-dep--chisel3--{{ checksum "chisel-release/chisel3/build.sbt" }}--{{ checksum "chisel-release/chisel3/project/plugins.sbt" }}
            - v1-dep--firrtl--{{ checksum "chisel-release/firrtl/build.sbt" }}--{{ checksum "chisel-release/firrtl/project/plugins.sbt" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dep--firrtl

      - publish-component:
          component: "dsptools"
          scalaVersion: "++2.12.10"
          sbtFlags: "'project rocket-dsptools'"
      - save-workspace:
          package: "rocket-dsptools_2.12"

  test-rocket-dsptools-2_12:
    executor: chisel-executor

    steps:
      - restore-workspace
      - restore_cache:
          keys:
            - v1-dep--rocketchip--{{ checksum "chisel-release/rocketchip/build.sbt" }}--{{ checksum "chisel-release/rocketchip/project/plugins.sbt" }}
            - v1-dep--dsptools--{{ checksum "chisel-release/dsptools/build.sbt" }}--{{ checksum "chisel-release/dsptools2/project/plugins.sbt" }}
            - v1-dep--chisel-testers2--{{ checksum "chisel-release/chisel-testers2/build.sbt" }}--{{ checksum "chisel-release/chisel-testers2/project/plugins.sbt" }}
            - v1-dep--chisel-testers--{{ checksum "chisel-release/chisel-testers/build.sbt" }}--{{ checksum "chisel-release/chisel-testers/project/plugins.sbt" }}
            - v1-dep--chisel3--{{ checksum "chisel-release/chisel3/build.sbt" }}--{{ checksum "chisel-release/chisel3/project/plugins.sbt" }}
            - v1-dep--firrtl--{{ checksum "chisel-release/firrtl/build.sbt" }}--{{ checksum "chisel-release/firrtl/project/plugins.sbt" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dep--firrtl

      - test-component:
          component: "dsptools"
          scalaVersion: "++2.12.10"
          sbtFlags: "'project rocket-dsptools'"

  build-rocket-chip:
    executor: chisel-executor

    steps:
      - restore-workspace
      - restore_cache:
          keys:
            - v1-dep--rocket-chip--{{ checksum "chisel-release/rocket-chip/build.sbt" }}--{{ checksum "chisel-release/rocket-chip/project/plugins.sbt" }}
            - v1-dep--dsptools--{{ checksum "chisel-release/dsptools/build.sbt" }}--{{ checksum "chisel-release/dsptools2/project/plugins.sbt" }}
            - v1-dep--chisel-testers2--{{ checksum "chisel-release/chisel-testers2/build.sbt" }}--{{ checksum "chisel-release/chisel-testers2/project/plugins.sbt" }}
            - v1-dep--chisel-testers--{{ checksum "chisel-release/chisel-testers/build.sbt" }}--{{ checksum "chisel-release/chisel-testers/project/plugins.sbt" }}
            - v1-dep--chisel3--{{ checksum "chisel-release/chisel3/build.sbt" }}--{{ checksum "chisel-release/chisel3/project/plugins.sbt" }}
            - v1-dep--firrtl--{{ checksum "chisel-release/firrtl/build.sbt" }}--{{ checksum "chisel-release/firrtl/project/plugins.sbt" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dep--firrtl

      # publish rocket-chip
      - publish-component:
          component: "rocket-chip"
          scalaVersion: "++2.12.10"
          sbtFlags: "-DROCKET_USE_MAVEN"
      - save-workspace:
          package: "rocketchip_2.12"
      - save_cache:
          paths:
            - ~/.coursier
            - ~/.ivy2
            - ~/.m2
            - ~/.sbt
          key: v1-dep--rocket-chip--{{ checksum "chisel-release/rocket-chip/build.sbt" }}--{{ checksum "chisel-release/rocket-chip/project/plugins.sbt" }}

  test-rocket-chip-2_12:
    executor: chisel-executor

    steps:
      - restore-workspace
      - restore_cache:
          keys:
            - v1-dep--rocketchip--{{ checksum "chisel-release/rocketchip/build.sbt" }}--{{ checksum "chisel-release/rocketchip/project/plugins.sbt" }}
            - v1-dep--dsptools--{{ checksum "chisel-release/dsptools/build.sbt" }}--{{ checksum "chisel-release/dsptools2/project/plugins.sbt" }}
            - v1-dep--chisel-testers2--{{ checksum "chisel-release/chisel-testers2/build.sbt" }}--{{ checksum "chisel-release/chisel-testers2/project/plugins.sbt" }}
            - v1-dep--chisel-testers--{{ checksum "chisel-release/chisel-testers/build.sbt" }}--{{ checksum "chisel-release/chisel-testers/project/plugins.sbt" }}
            - v1-dep--chisel3--{{ checksum "chisel-release/chisel3/build.sbt" }}--{{ checksum "chisel-release/chisel3/project/plugins.sbt" }}
            - v1-dep--firrtl--{{ checksum "chisel-release/firrtl/build.sbt" }}--{{ checksum "chisel-release/firrtl/project/plugins.sbt" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dep--firrtl

      - test-component:
          component: "rocket-chip"
          scalaVersion: "++2.12.10"
          sbtFlags: "-DROCKET_USE_MAVEN"

workflows:

  build_and_test:
    jobs:
      - build-prep
      - build-firrtl:
          requires:
            - build-prep
      - build-chisel:
          requires:
            - build-firrtl
      - build-treadle:
          requires:
            - build-firrtl
      - build-firrtl-interpreter:
          requires:
            - build-firrtl
      - build-chisel-testers2:
          requires:
            - build-firrtl
            - build-chisel
            - build-treadle
            - build-firrtl-interpreter
      - build-chisel-testers:
          requires:
            - build-firrtl
            - build-chisel
            - build-treadle
            - build-firrtl-interpreter
      - build-diagrammer:
          requires:
            - build-chisel
      - build-dsptools:
          requires:
            - build-chisel
            - build-treadle
            - build-firrtl-interpreter
            - build-chisel-testers
            - build-chisel-testers2
      - build-rocket-chip:
          requires:
            - build-chisel
            - build-treadle
            - build-firrtl-interpreter
            - build-chisel-testers
            - build-chisel-testers2
      - build-rocket-dsptools:
          requires:
            - build-chisel
            - build-treadle
            - build-firrtl-interpreter
            - build-chisel-testers
            - build-chisel-testers2
            - build-rocket-chip
#      - test-firrtl-2_11:
#          requires:
#            - build-firrtl
#      - test-firrtl-2_12:
#          requires:
#            - build-firrtl
      - test-firrtl-interpreter-2_11:
          requires:
            - build-firrtl-interpreter
      - test-firrtl-interpreter-2_12:
          requires:
            - build-firrtl-interpreter
      - test-treadle-2_11:
          requires:
            - build-treadle
      - test-treadle-2_12:
          requires:
            - build-treadle
      - test-chisel-2_11:
          requires:
            - build-chisel
      - test-chisel-2_12:
          requires:
            - build-chisel
      - checkstyle-chisel:
          # Strictly speaking, this is only dependent on build-firrtl,
          #  but it is faster than the test jobs so if it fails,
          #  it fails the entire build before we get a chance to complete the tests.
          # If we make it dependent on at least one of the tests,
          #  there's a better chance to see if the tests fail before we flag a style failure
          requires:
            - test-chisel-2_12
#      - test-diagrammer-2_11:
#          requires:
#            - build-diagrammer
#      - test-diagrammer-2_12:
#          requires:
#            - build-diagrammer
      - test-chisel-testers-2_11:
          requires:
            - build-chisel-testers
      - test-chisel-testers-2_12:
          requires:
            - build-chisel-testers
      - test-chisel-testers2-2_11:
          requires:
            - build-chisel-testers2
      - test-chisel-testers2-2_12:
          requires:
            - build-chisel-testers2
      - test-dsptools-2_11:
          requires:
            - build-dsptools
      - test-dsptools-2_12:
          requires:
            - build-dsptools
      - test-chisel-testers-2_11:
          requires:
            - build-chisel-testers
      - test-chisel-testers-2_12:
          requires:
            - build-chisel-testers
      - test-rocket-chip-2_12:
          requires:
            - build-rocket-chip
      - test-rocket-dsptools-2_12:
          requires:
            - build-rocket-dsptools
