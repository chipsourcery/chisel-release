# Scala CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/sample-config/ for more details
#
version: 2

jobs:
  build-prep:
    docker:
      - image: ucbjrl/chisel3-ci
        user: "chisel"

    working_directory: ~/src/chisel-release

    steps:
      # Download and cache dependencies
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
            - source-v1-{{ .Branch }}-
            - source-v1-

      - checkout
      - run:
          command: |
            git submodule sync
            git submodule update --init --recursive

      - save_cache:
          paths:
            - ~/.ivy2/cache
            - ~/.sbt
          key: source-v1-{{ .Branch }}-{{ .Revision }}
      - persist_to_workspace:
          root: /home/chisel
          paths:
            - src/chisel-release

  build-firrtl:
    docker:
      - image: ucbjrl/chisel3-ci
        user: "chisel"

    working_directory: ~/src/chisel-release

    steps:
      - attach_workspace:
          at: /home/chisel
      # Download and cache dependencies
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
            - source-v1-{{ .Branch }}-
            - source-v1-

      - run: cd firrtl && sbt +clean +publishLocal

      - save_cache:
          paths:
            - ~/.ivy2/cache
            - ~/.sbt
          key: source-v1-{{ .Branch }}-{{ .Revision }}
      - persist_to_workspace:
          root: /home/chisel
          paths:
            - .ivy2/local
            - src/chisel-release/firrtl/target

  build-firrtl-interpreter:
    docker:
      - image: ucbjrl/chisel3-ci
        user: "chisel"

    working_directory: ~/src/chisel-release

    steps:
      - attach_workspace:
          at: /home/chisel
      # Download and cache dependencies
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
            - source-v1-{{ .Branch }}-
            - source-v1-

      - run: cd firrtl-interpreter && sbt +clean +publishLocal

      - save_cache:
          paths:
            - ~/.ivy2/cache
            - ~/.sbt
          key: source-v1-{{ .Branch }}-{{ .Revision }}
      - persist_to_workspace:
          root: /home/chisel
          paths:
            - .ivy2/local
            - src/chisel-release/firrtl-interpreter/target

  build-treadle:
    docker:
      - image: ucbjrl/chisel3-ci
        user: "chisel"

    working_directory: ~/src/chisel-release

    steps:
      - attach_workspace:
          at: /home/chisel
      # Download and cache dependencies
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
            - source-v1-{{ .Branch }}-
            - source-v1-

      - run: cd treadle && sbt +clean +publishLocal

      - save_cache:
          paths:
            - ~/.ivy2/cache
            - ~/.sbt
          key: source-v1-{{ .Branch }}-{{ .Revision }}
      - persist_to_workspace:
          root: /home/chisel
          paths:
            - .ivy2/local
            - src/chisel-release/treadle/target


  build-chisel:
    docker:
      - image: ucbjrl/chisel3-ci
        user: "chisel"

    working_directory: ~/src/chisel-release

    steps:
      - attach_workspace:
          at: /home/chisel
      # Download and cache dependencies
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
            - source-v1-{{ .Branch }}-
            - source-v1-

      - run: cd chisel3 && sbt +clean +publishLocal

      - save_cache:
          paths:
            - ~/.ivy2/cache
            - ~/.sbt
          key: source-v1-{{ .Branch }}-{{ .Revision }}
      - persist_to_workspace:
          root: /home/chisel
          paths:
            - .ivy2/local
             - src/chisel-release/chisel3/target
         
  build-chisel-testers:
    docker:
      - image: ucbjrl/chisel3-ci
        user: "chisel"

    working_directory: ~/src/chisel-release

    steps:
      - attach_workspace:
          at: /home/chisel
      # Download and cache dependencies
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
            - source-v1-{{ .Branch }}-
            - source-v1-

      - run: cd chisel-testers && sbt +clean +publishLocal

      - save_cache:
          paths:
            - ~/.ivy2/cache
            - ~/.sbt
          key: source-v1-{{ .Branch }}-{{ .Revision }}
      - persist_to_workspace:
          root: /home/chisel
          paths:
            - .ivy2/local
            - src/chisel-testers/firrtl/target
          
  build-dsptools:
    docker:
      - image: ucbjrl/chisel3-ci
        user: "chisel"

    working_directory: ~/src/chisel-release

    steps:
      - attach_workspace:
          at: /home/chisel
      # Download and cache dependencies
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
            - source-v1-{{ .Branch }}-
            - source-v1-

      - run: cd dsptools && sbt +clean +publishLocal

      - save_cache:
          paths:
            - ~/.ivy2/cache
            - ~/.sbt
          key: source-v1-{{ .Branch }}-{{ .Revision }}
      - persist_to_workspace:
          root: /home/chisel
          paths:
            - .ivy2/local
            - src/chisel-release/dsptools/target
          
  test-firrtl:
    docker:
      # specify the version you desire here
      - image: ucbjrl/chisel3-ci
        user: "chisel"

    working_directory: ~/src/chisel-release
        
    steps:
      - attach_workspace:
          at: /home/chisel
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
            - source-v1-{{ .Branch }}-
            - source-v1-
      - run:
          command: |
            cd firrtl
            PATH="/opt/verilator/verilator_3_904/bin:$PATH" sbt +test
          # no_output_timeout: 3m
          
  test-firrtl-interpreter:
    docker:
      # specify the version you desire here
      - image: ucbjrl/chisel3-ci
        user: "chisel"

    working_directory: ~/src/chisel-release
        
    steps:
      - attach_workspace:
          at: /home/chisel
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
            - source-v1-{{ .Branch }}-
            - source-v1-
      - run:
          command: |
            cd firrtl-interpreter
            PATH="/opt/verilator/verilator_3_904/bin:$PATH" sbt +test
          # no_output_timeout: 3m
          
  test-treadle:
    docker:
      # specify the version you desire here
      - image: ucbjrl/chisel3-ci
        user: "chisel"

    working_directory: ~/src/chisel-release
        
    steps:
      - attach_workspace:
          at: /home/chisel
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
            - source-v1-{{ .Branch }}-
            - source-v1-
      - run:
          command: |
            cd treadle
            PATH="/opt/verilator/verilator_3_904/bin:$PATH" sbt +test
          # no_output_timeout: 3m
          
  test-chisel:
    docker:
      # specify the version you desire here
      - image: ucbjrl/chisel3-ci
        user: "chisel"

    working_directory: ~/src/chisel-release
        
    steps:
      - attach_workspace:
          at: /home/chisel
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
            - source-v1-{{ .Branch }}-
            - source-v1-
      # We seem to have memory leaks in chisel tests -
      # we run out of memory trying to "sbt +test" but a single "sbt test" passes.
      - run:
          command: |
            cd chisel3
            PATH="/opt/verilator/verilator_3_904/bin:$PATH" sbt test
          # no_output_timeout: 3m
          
  test-chisel-testers:
    docker:
      # specify the version you desire here
      - image: ucbjrl/chisel3-ci
        user: "chisel"

    working_directory: ~/src/chisel-release
        
    steps:
      - attach_workspace:
          at: /home/chisel
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
            - source-v1-{{ .Branch }}-
            - source-v1-
      - run:
          command: |
            cd chisel-testers
            PATH="/opt/verilator/verilator_3_904/bin:$PATH" sbt +test
          # no_output_timeout: 3m
          
  test-dsptools:
    docker:
      # specify the version you desire here
      - image: ucbjrl/chisel3-ci
        user: "chisel"

    working_directory: ~/src/chisel-release
        
    steps:
      - attach_workspace:
          at: /home/chisel
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
            - source-v1-{{ .Branch }}-
            - source-v1-
      - run:
          command: |
            cd dsptools
            PATH="/opt/verilator/verilator_3_904/bin:$PATH" sbt +test
          # no_output_timeout: 3m

workflows:
  version: 2
  build_and_test:
    jobs:
      - build-firrtl
      - build-firrtl-interpreter:
          requires:
            - build-firrtl
      - build-treadle:
          requires:
            - build-firrtl
      - build-chisel:
          requires:
            - build-firrtl
            - build-firrtl-interpreter
      - build-chisel-testers:
          requires:
            - build-firrtl
            - build-firrtl-interpreter
            - build-chisel
      - build-dsptools:
          requires:
            - build-firrtl
            - build-firrtl-interpreter
            - build-chisel
            - build-chisel-testers
      - test-firrtl:
          requires:
            - build-firrtl
      - test-firrtl-interpreter:
          requires:
            - build-firrtl-interpreter
      - test-treadle:
          requires:
            - build-treadle
      - test-chisel:
          requires:
            - build-chisel
      - test-chisel-testers:
          requires:
            - build-chisel-testers
      - test-dsptools:
          requires:
            - build-dsptools
